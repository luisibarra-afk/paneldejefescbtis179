<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circulares â€” CBTis 179</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#F0EDE7; --surface:#FAF8F5; --card:#FFFFFF;
  --border:#E0DBD3; --border2:#CEC9C0;
  --text:#1A1714; --muted:#8C8479; --lite:#C0BAB0;
  --guinda:#6B2D52; --guinda-d:#4A1E39; --oro:#B8872A;
  --mora:#7D3C98; --mora-l:#F5EEF8;
  --green:#166534; --green-l:#DCFCE7;
  --yellow:#854D0E; --yellow-l:#FEF9C3;
  --red:#991B1B; --red-l:#FEE2E2;
  --blue:#1A4F7A; --blue-l:#EAF2FA;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
.site-header{background:var(--guinda-d);position:relative;overflow:hidden;}
.site-header::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 24px,rgba(255,255,255,.025) 24px,rgba(255,255,255,.025) 25px);}
.header-inner{position:relative;z-index:1;padding:20px 32px;display:flex;align-items:center;gap:16px;}
.header-icon{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.header-text h1{font-family:'Playfair Display',serif;font-size:20px;color:#fff;line-height:1.2;}
.header-text p{font-size:11px;color:rgba(255,255,255,.5);margin-top:2px;font-weight:300;}
.header-back{margin-left:auto;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 16px;font-size:12px;font-weight:600;color:#fff;text-decoration:none;transition:background .15s;}
.header-back:hover{background:rgba(255,255,255,.2);}

/* NAV */
.site-nav{background:var(--guinda-d);border-bottom:2px solid var(--oro);display:flex;padding:0 32px;}
.site-nav a{padding:10px 18px;font-size:10px;font-weight:600;color:rgba(255,255,255,.45);text-decoration:none;text-transform:uppercase;letter-spacing:.08em;border-bottom:2px solid transparent;margin-bottom:-2px;transition:color .15s,border-color .15s;}
.site-nav a:hover{color:rgba(255,255,255,.8);}
.site-nav a.active{color:#fff;border-bottom-color:var(--oro);}

/* STATS BAR */
.stats-bar{display:grid;grid-template-columns:repeat(4,1fr);background:var(--surface);border-bottom:1px solid var(--border);}
.stat-cell{padding:12px 20px;border-right:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.stat-cell:last-child{border-right:none;}
.stat-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.stat-num{font-family:'Playfair Display',serif;font-size:20px;line-height:1;}
.stat-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-top:1px;}

/* MAIN */
.main{padding:28px 32px;max-width:1100px;margin:0 auto;}
.page-title{font-family:'Playfair Display',serif;font-size:24px;color:var(--guinda);margin-bottom:4px;}
.page-sub{font-size:12px;color:var(--muted);margin-bottom:24px;font-weight:300;}

/* TOP BAR */
.top-bar{display:flex;align-items:center;gap:12px;margin-bottom:24px;flex-wrap:wrap;}
.btn-nueva{background:var(--mora);color:#fff;border:none;border-radius:10px;padding:10px 22px;font-family:'Outfit',sans-serif;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;transition:opacity .15s;}
.btn-nueva:hover{opacity:.87;}
.filter-wrap{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto;}
.filter-btn{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;font-family:'Outfit',sans-serif;transition:all .15s;}
.filter-btn:hover,.filter-btn.on{background:var(--mora);color:#fff;border-color:var(--mora);}
.filter-btn.f-pendiente.on{background:#854D0E;border-color:#854D0E;}
.filter-btn.f-proceso.on{background:var(--blue);border-color:var(--blue);}
.filter-btn.f-atendida.on{background:var(--green);border-color:var(--green);}

/* SEARCH */
.search-wrap{position:relative;flex:1;min-width:200px;max-width:340px;}
.search-wrap input{width:100%;border:1px solid var(--border);border-radius:10px;padding:8px 12px 8px 36px;font-family:'Outfit',sans-serif;font-size:13px;background:var(--surface);outline:none;color:var(--text);transition:border-color .15s;}
.search-wrap input:focus{border-color:var(--mora);}
.search-wrap::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none;}

/* LIST */
.circ-list{display:flex;flex-direction:column;gap:12px;}
.empty-state{text-align:center;padding:48px 24px;color:var(--muted);}
.empty-state .ei{font-size:40px;margin-bottom:12px;}
.empty-state p{font-size:13px;}

/* CIRCULAR CARD */
.circ-card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04);transition:box-shadow .2s;}
.circ-card:hover{box-shadow:0 4px 20px rgba(0,0,0,.08);}
.circ-card.atendida{opacity:.75;}

/* card top strip by status */
.circ-strip{height:4px;}

/* card header row */
.circ-top{display:flex;align-items:flex-start;gap:14px;padding:16px 20px 10px;}
.circ-num-badge{
  flex-shrink:0;width:44px;height:44px;border-radius:11px;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:800;color:#fff;line-height:1.1;text-align:center;
}
.circ-info{flex:1;min-width:0;}
.circ-titulo{font-size:14px;font-weight:700;line-height:1.3;margin-bottom:4px;}
.circ-desc{font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:8px;}
.circ-meta-row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
.cmeta{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:2px 9px;}
.cmeta strong{color:var(--text);font-weight:600;}
.cmeta.urgent{background:var(--red-l);border-color:#FECACA;color:var(--red);}
.cmeta.urgent strong{color:var(--red);}

/* status badge */
.status-badge{flex-shrink:0;border-radius:20px;padding:5px 13px;font-size:10px;font-weight:700;letter-spacing:.04em;border:1px solid;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .15s;white-space:nowrap;align-self:flex-start;}
.s-pendiente{background:#EDEBE4;color:var(--muted);border-color:var(--border);}
.s-pendiente:hover{background:#E3E0D9;}
.s-proceso{background:var(--yellow-l);color:var(--yellow);border-color:#FDE68A;}
.s-proceso:hover{background:#FEF08A;}
.s-atendida{background:var(--green-l);color:var(--green);border-color:#86EFAC;}
.s-atendida:hover{background:#BBF7D0;}

/* card bottom */
.circ-bottom{padding:0 20px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.circ-links{display:flex;gap:6px;flex-wrap:wrap;flex:1;}
.circ-link{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:600;color:var(--mora);background:var(--mora-l);border:1px solid #DDD0F0;border-radius:6px;padding:3px 10px;text-decoration:none;transition:background .15s;}
.circ-link:hover{background:#EDE0F8;}
.circ-file{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:600;color:var(--blue);background:var(--blue-l);border:1px solid #C5D8EC;border-radius:6px;padding:3px 10px;text-decoration:none;transition:background .15s;}
.circ-file:hover{background:#D6E8F5;}
.circ-atendido-by{font-size:10px;color:var(--green);font-weight:600;display:flex;align-items:center;gap:5px;margin-left:auto;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:900;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal-box{background:#fff;border-radius:20px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.25);transform:translateY(16px);transition:transform .2s;}
.modal-overlay.open .modal-box{transform:none;}
.modal-header{padding:22px 24px 0;display:flex;align-items:center;justify-content:space-between;}
.modal-header h2{font-family:'Playfair Display',serif;font-size:18px;color:var(--guinda);}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);line-height:1;padding:4px;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:20px 24px 28px;}

/* FORM */
.form-row{margin-bottom:16px;}
.form-row label{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:5px;}
.form-row input,.form-row textarea,.form-row select{width:100%;border:1px solid var(--border);border-radius:9px;padding:10px 12px;font-family:'Outfit',sans-serif;font-size:13px;color:var(--text);background:var(--bg);outline:none;transition:border-color .15s;}
.form-row input:focus,.form-row textarea:focus,.form-row select:focus{border-color:var(--mora);}
.form-row textarea{resize:vertical;min-height:70px;line-height:1.5;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-hint{font-size:10px;color:var(--lite);margin-top:4px;}

/* link rows */
.link-rows{display:flex;flex-direction:column;gap:8px;margin-bottom:8px;}
.link-row{display:flex;gap:8px;}
.link-row input{flex:1;}
.link-row select{width:130px;flex-shrink:0;}
.btn-add-link{background:none;border:1px dashed var(--border2);border-radius:8px;padding:7px 14px;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;font-family:'Outfit',sans-serif;transition:all .15s;}
.btn-add-link:hover{border-color:var(--mora);color:var(--mora);}
.btn-rm{background:none;border:none;color:var(--lite);font-size:16px;cursor:pointer;padding:0 4px;line-height:1;flex-shrink:0;}
.btn-rm:hover{color:var(--red);}

/* file upload zone */
.upload-zone{border:2px dashed var(--border2);border-radius:10px;padding:18px;text-align:center;cursor:pointer;transition:all .15s;background:var(--bg);}
.upload-zone:hover,.upload-zone.drag{border-color:var(--mora);background:var(--mora-l);}
.upload-zone input[type=file]{display:none;}
.upload-zone .uz-icon{font-size:24px;margin-bottom:6px;}
.upload-zone p{font-size:12px;color:var(--muted);}
.upload-zone .uz-name{font-size:11px;font-weight:600;color:var(--mora);margin-top:4px;}

/* modal footer */
.modal-footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--border);padding-top:16px;margin-top:4px;}
.btn-cancel{background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:9px 20px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:background .15s;}
.btn-cancel:hover{background:var(--border);}
.btn-submit{background:var(--mora);color:#fff;border:none;border-radius:9px;padding:9px 24px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:opacity .15s;}
.btn-submit:hover{opacity:.87;}

/* ATENDER MODAL */
.aten-label{font-size:13px;color:var(--text);margin-bottom:14px;line-height:1.5;}

/* CONFIRM MODAL */
.confirm-box{max-width:380px;}
.confirm-icon{font-size:36px;text-align:center;margin-bottom:10px;}
.confirm-msg{font-size:13px;color:var(--muted);line-height:1.5;text-align:center;margin-bottom:4px;}
.confirm-name{font-size:14px;font-weight:700;color:var(--text);text-align:center;margin-bottom:4px;}
.confirm-num{font-size:11px;color:var(--muted);text-align:center;margin-bottom:20px;}
.btn-delete-confirm{background:var(--red);color:#fff;border:none;border-radius:9px;padding:9px 24px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:opacity .15s;}
.btn-delete-confirm:hover{opacity:.85;}
.toast{position:fixed;bottom:24px;right:24px;padding:10px 18px;border-radius:10px;font-size:12px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.15);opacity:0;transform:translateY(8px);transition:all .25s;pointer-events:none;z-index:999;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.ok{background:var(--green);color:#fff;}
.toast.info{background:var(--mora);color:#fff;}

/* FOOTER */
.site-footer{margin-top:48px;background:var(--guinda-d);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.site-footer span{font-size:10px;color:rgba(255,255,255,.35);}
.site-footer strong{color:rgba(255,255,255,.6);}

@media(max-width:650px){
  .main{padding:16px;}
  .header-inner{padding:14px 16px;}
  .stats-bar{grid-template-columns:repeat(2,1fr);}
  .form-grid{grid-template-columns:1fr;}
  .top-bar{gap:8px;}
  .filter-wrap{margin-left:0;}
}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <div class="header-icon">ğŸ“¨</div>
    <div class="header-text">
      <h1>Circulares Institucionales</h1>
      <p>CBTis 179 Â· DGETI Â· SEMS Â· Ciclo Escolar 2025â€“2026</p>
    </div>
    <a href="index.html" class="header-back">â† Inicio</a>
  </div>
</header>

<nav class="site-nav">
  <a href="index.html">Inicio</a>
  <a href="gantt_sems.html">Programas Institucionales</a>
  <a href="supervision.html">SupervisiÃ³n</a>
  <a href="circulares.html" class="active">Circulares</a>
  <a href="eventos.html">Eventos</a>
</nav>

<div class="stats-bar">
  <div class="stat-cell"><div class="stat-dot" style="background:var(--mora)"></div><div><div class="stat-num" id="st-total">0</div><div class="stat-lbl">Total</div></div></div>
  <div class="stat-cell"><div class="stat-dot" style="background:var(--muted)"></div><div><div class="stat-num" id="st-pend">0</div><div class="stat-lbl">Pendientes</div></div></div>
  <div class="stat-cell"><div class="stat-dot" style="background:var(--yellow)"></div><div><div class="stat-num" id="st-proc">0</div><div class="stat-lbl">En proceso</div></div></div>
  <div class="stat-cell"><div class="stat-dot" style="background:var(--green)"></div><div><div class="stat-num" id="st-aten">0</div><div class="stat-lbl">Atendidas</div></div></div>
</div>

<div class="sync-bar">
  <div class="sync-dot" id="syncDot"></div>
  <span id="syncMsg">Conectando con Google Sheetsâ€¦</span>
  <button onclick="loadFromSheets()" style="margin-left:auto;background:none;border:1px solid var(--border);border-radius:6px;padding:3px 12px;font-size:10px;font-weight:600;color:var(--muted);cursor:pointer;font-family:'Outfit',sans-serif">ğŸ”„ Actualizar</button>
</div>

<div class="main">
  <div class="page-title">Registro de Circulares</div>
  <div class="page-sub">Carga circulares de DGETI, SEMS u otras instancias Â· Registra quiÃ©n las atendiÃ³ y cuÃ¡ndo Â· Adjunta archivos o enlaces de conferencias</div>

  <div class="top-bar">
    <button class="btn-nueva" onclick="openModal()">ï¼‹ Nueva circular</button>
    <div class="search-wrap">
      <input type="text" id="searchInput" placeholder="Buscar por tÃ­tulo, nÃºmero, Ã¡reaâ€¦" oninput="renderList()">
    </div>
    <div class="filter-wrap">
      <button class="filter-btn f-todas on" onclick="setFilter('todas',this)">Todas</button>
      <button class="filter-btn f-pendiente" onclick="setFilter('Pendiente',this)">Pendientes</button>
      <button class="filter-btn f-proceso" onclick="setFilter('En proceso',this)">En proceso</button>
      <button class="filter-btn f-atendida" onclick="setFilter('Atendida',this)">Atendidas</button>
    </div>
  </div>

  <div class="circ-list" id="circList"></div>
</div>

<footer class="site-footer">
  <span>CBTis 179 Â· Circulares Â· Ciclo Escolar <strong>2025â€“2026</strong></span>
  <span>SEP Â· DGETI Â· SEMS Â· Hidalgo</span>
</footer>

<div class="toast" id="toast"></div>

<!-- â•â• MODAL NUEVA CIRCULAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modalOverlay" onclick="closeOnBg(event)">
  <div class="modal-box">
    <div class="modal-header">
      <h2 id="modalTitle">Nueva Circular</h2>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label>NÃºmero de circular</label>
          <input type="text" id="f-num" placeholder="Ej. DGETI-2026-015">
        </div>
        <div class="form-row">
          <label>Ãrea / Instancia</label>
          <select id="f-area">
            <option value="">â€” Seleccionar â€”</option>
            <option>DGETI</option>
            <option>SEMS</option>
            <option>SEP</option>
            <option>DirecciÃ³n General</option>
            <option>SubdirecciÃ³n AcadÃ©mica</option>
            <option>ProtecciÃ³n Civil</option>
            <option>Otra</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <label>TÃ­tulo / Asunto</label>
        <input type="text" id="f-titulo" placeholder="Ej. Lineamientos para evaluaciÃ³n primer parcial 2026">
      </div>

      <div class="form-row">
        <label>DescripciÃ³n (opcional)</label>
        <textarea id="f-desc" placeholder="Describe brevemente el contenido o instrucciones de la circularâ€¦"></textarea>
      </div>

      <div class="form-grid">
        <div class="form-row">
          <label>Fecha de emisiÃ³n</label>
          <input type="date" id="f-emision">
        </div>
        <div class="form-row">
          <label>Fecha lÃ­mite de atenciÃ³n</label>
          <input type="date" id="f-limite">
          <div class="form-hint">Se marcarÃ¡ como urgente si estÃ¡ prÃ³xima a vencer</div>
        </div>
      </div>

      <div class="form-row">
        <label>Responsable del Ã¡rea</label>
        <input type="text" id="f-responsable" placeholder="Ej. Lic. Betty Camargo Aparicio">
      </div>

      <div class="form-row">
        <label>Adjuntar archivo (PDF, imagen)</label>
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('f-file').click()" ondragover="dragOver(event)" ondrop="dropFile(event)" ondragleave="dragLeave(event)">
          <input type="file" id="f-file" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx" onchange="fileSelected(event)">
          <div class="uz-icon">ğŸ“</div>
          <p>Clic para seleccionar o arrastra aquÃ­<br><span style="font-size:10px">PDF, imagen, Word</span></p>
          <div class="uz-name" id="uzName"></div>
        </div>
      </div>

      <div class="form-row">
        <label>Links (conferencias, Drive, reunionesâ€¦)</label>
        <div class="link-rows" id="linkRows">
          <div class="link-row">
            <select>
              <option>ğŸ¥ Conferencia</option>
              <option>ğŸ“ Drive</option>
              <option>ğŸ”— Otro</option>
            </select>
            <input type="url" placeholder="https://meet.google.com/...">
            <button class="btn-rm" onclick="rmLink(this)">âœ•</button>
          </div>
        </div>
        <button class="btn-add-link" onclick="addLink()">ï¼‹ Agregar otro link</button>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
        <button class="btn-submit" onclick="guardarCircular()">ğŸ’¾ Guardar circular</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â• MODAL ATENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="atenOverlay" onclick="closeAtenOnBg(event)">
  <div class="modal-box" style="max-width:420px">
    <div class="modal-header">
      <h2>Marcar como atendida</h2>
      <button class="modal-close" onclick="closeAten()">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="aten-label" id="atenLabel"></p>
      <div class="form-row">
        <label>Â¿QuiÃ©n la atendiÃ³?</label>
        <input type="text" id="a-quien" placeholder="Nombre completo">
      </div>
      <div class="form-row">
        <label>Fecha en que se atendiÃ³</label>
        <input type="date" id="a-fecha">
      </div>
      <div class="form-row">
        <label>Observaciones (opcional)</label>
        <textarea id="a-obs" placeholder="Describe cÃ³mo se atendiÃ³, evidencias, etc." style="min-height:56px"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeAten()">Cancelar</button>
        <button class="btn-submit" style="background:var(--green)" onclick="confirmarAten()">âœ“ Confirmar atenciÃ³n</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â• MODAL CONFIRMAR ELIMINAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay confirm-box" id="confirmOverlay" onclick="if(event.target===this)closeConfirm()">
  <div class="modal-box confirm-box">
    <div class="modal-header" style="justify-content:center;padding-bottom:4px;">
      <h2 style="color:var(--red)">Eliminar circular</h2>
    </div>
    <div class="modal-body" style="text-align:center;">
      <div class="confirm-icon">ğŸ—‘ï¸</div>
      <div class="confirm-msg">Â¿EstÃ¡s seguro de que quieres eliminar esta circular?</div>
      <div class="confirm-name" id="confirmTitle"></div>
      <div class="confirm-num" id="confirmNum"></div>
      <p style="font-size:11px;color:var(--red);margin-bottom:20px;font-weight:600;">Esta acciÃ³n no se puede deshacer.</p>
      <div class="modal-footer" style="justify-content:center;">
        <button class="btn-cancel" onclick="closeConfirm()">Cancelar</button>
        <button class="btn-delete-confirm" onclick="confirmDelete()">ğŸ—‘ï¸ SÃ­, eliminar</button>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let CIRCULARES = [];
let currentFilter = 'todas';
let editingId = null;
let atenId = null;
let fileDataUrl = null;
let fileNameStr = null;

// â•â• CONFIGURACIÃ“N â€” pega tu URL de Apps Script aquÃ­ â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://script.google.com/macros/s/AKfycbwlE1dBsGozUvVXL7zy3Ay9Fdo8F0CrJwj0pGUROm3lPXL24UMwduphmg96Nj1BL8_T/exec';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(state, msg){
  const dot=document.getElementById('syncDot');
  const txt=document.getElementById('syncMsg');
  if(dot) dot.className='sync-dot '+state;
  if(txt) txt.textContent=msg;
}

async function apiGet(params){
  const url=API_URL+'?'+new URLSearchParams(params);
  const res=await fetch(url);
  return res.json();
}

async function apiPost(body){
  const res=await fetch(API_URL,{method:'POST',body:JSON.stringify(body)});
  return res.json();
}

async function loadFromSheets(){
  setSyncStatus('saving','Cargando desde Google Sheetsâ€¦');
  document.getElementById('circList').innerHTML='<div class="empty-state"><div class="spinner"></div><p>Cargandoâ€¦</p></div>';
  try{
    const data=await apiGet({action:'circ_getAll'});
    if(data.error) throw new Error(data.error);
    CIRCULARES=(data.rows||[]).map(r=>({
      id:r.id, num:r.num, area:r.area, titulo:r.titulo, desc:r.desc,
      emision:r.emision, limite:r.limite, responsable:r.responsable,
      estatus:r.estatus||'Pendiente',
      links:Array.isArray(r.links)?r.links:[],
      fileName:r.fileName, fileData:null, // files not stored in sheets
      atendidoPor:r.atendidoPor, atendidoFecha:r.atendidoFecha, atendidoObs:r.atendidoObs
    }));
    setSyncStatus('ok','Sincronizado âœ“');
  } catch(e){
    setSyncStatus('error','Error: '+e.message);
    // Fallback localStorage
    try{ const sv=localStorage.getItem('circ_cbti_v1'); if(sv) CIRCULARES=JSON.parse(sv); }catch(e2){}
  }
  renderList();
}

// â”€â”€ STATUS CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S_COLOR = { Pendiente:'#8C8479', 'En proceso':'#854D0E', Atendida:'#166534' };
const S_STRIP = { Pendiente:'#DDD8CE', 'En proceso':'#FDE68A', Atendida:'#86EFAC' };
const S_BADGE = {
  Pendiente: 's-pendiente',
  'En proceso': 's-proceso',
  Atendida: 's-atendida'
};
const S_NEXT  = { Pendiente:'En proceso', 'En proceso':'Atendida' };

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList(){
  const q    = document.getElementById('searchInput').value.toLowerCase().trim();
  const list = document.getElementById('circList');

  let items = CIRCULARES.slice().reverse(); // newest first

  if(currentFilter !== 'todas'){
    items = items.filter(c => c.estatus === currentFilter);
  }
  if(q){
    items = items.filter(c =>
      (c.titulo||'').toLowerCase().includes(q) ||
      (c.num||'').toLowerCase().includes(q) ||
      (c.area||'').toLowerCase().includes(q) ||
      (c.responsable||'').toLowerCase().includes(q)
    );
  }

  updateStats();

  if(!items.length){
    list.innerHTML = `<div class="empty-state"><div class="ei">ğŸ“­</div><p>${CIRCULARES.length ? 'Sin resultados para tu bÃºsqueda.' : 'AÃºn no hay circulares registradas.<br>Presiona <strong>+ Nueva circular</strong> para comenzar.'}</p></div>`;
    return;
  }

  list.innerHTML = items.map(c => cardHTML(c)).join('');
}

function cardHTML(c){
  const isUrgent = c.limite && c.estatus !== 'Atendida' && daysLeft(c.limite) <= 5;
  const dl = c.limite ? daysLeft(c.limite) : null;

  const metaFecha = c.emision ? `<div class="cmeta">ğŸ“… Emitida: <strong>${fmtDate(c.emision)}</strong></div>` : '';
  const metaLimite = c.limite
    ? `<div class="cmeta ${isUrgent?'urgent':''}">â° Vence: <strong>${fmtDate(c.limite)}</strong>${dl !== null && c.estatus!=='Atendida' ? ` (${dl<0?'vencida':dl+' dÃ­as'})` : ''}</div>`
    : '';
  const metaResp = c.responsable ? `<div class="cmeta">ğŸ‘¤ Responsable: <strong>${c.responsable}</strong></div>` : '';
  const metaArea = c.area ? `<div class="cmeta">ğŸ›ï¸ <strong>${c.area}</strong></div>` : '';

  const links = (c.links||[]).filter(l=>l.url).map(l=>
    `<a class="circ-link" href="${l.url}" target="_blank">${l.tipo} Ver enlace</a>`
  ).join('');

  const fileLink = c.fileName
    ? `<a class="circ-file" href="${c.fileData||'#'}" download="${c.fileName}">ğŸ“ ${c.fileName}</a>`
    : '';

  const atendidoPor = c.estatus==='Atendida' && c.atendidoPor
    ? `<span class="circ-atendido-by">âœ“ Atendida por <strong style="margin-left:4px">${c.atendidoPor}</strong> Â· ${fmtDate(c.atendidoFecha)}</span>`
    : '';

  // status btn label
  const btnLbl = c.estatus==='Atendida' ? 'âœ“ Atendida' : (S_NEXT[c.estatus] ? `â†’ ${S_NEXT[c.estatus]}` : c.estatus);

  return `<div class="circ-card ${c.estatus==='Atendida'?'atendida':''}" id="circ-${c.id}">
    <div class="circ-strip" style="background:${S_STRIP[c.estatus]}"></div>
    <div class="circ-top">
      <div class="circ-num-badge" style="background:${S_COLOR[c.estatus]}">${c.num||'#'}</div>
      <div class="circ-info">
        <div class="circ-titulo">${c.titulo||'Sin tÃ­tulo'}</div>
        ${c.desc?`<div class="circ-desc">${c.desc}</div>`:''}
        <div class="circ-meta-row">
          ${metaArea}${metaFecha}${metaLimite}${metaResp}
        </div>
        ${c.atendidoObs?`<div style="font-size:11px;color:var(--green);margin-top:6px">ğŸ“ ${c.atendidoObs}</div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0">
        <button class="status-badge ${S_BADGE[c.estatus]}" onclick="cycleStatus('${c.id}')">${btnLbl}</button>
        <div style="display:flex;gap:6px">
          <button onclick="openEdit('${c.id}')" style="background:none;border:1px solid var(--border);border-radius:6px;padding:3px 10px;font-size:10px;color:var(--muted);cursor:pointer;font-family:'Outfit',sans-serif">âœï¸ Editar</button>
          <button onclick="deleteCirc('${c.id}')" style="background:none;border:1px solid #FECACA;border-radius:6px;padding:3px 10px;font-size:10px;color:var(--red);cursor:pointer;font-family:'Outfit',sans-serif">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>
    ${(links||fileLink||atendidoPor)?`<div class="circ-bottom">${links}${fileLink}${atendidoPor}</div>`:''}
  </div>`;
}

function updateStats(){
  const total = CIRCULARES.length;
  const pend  = CIRCULARES.filter(c=>c.estatus==='Pendiente').length;
  const proc  = CIRCULARES.filter(c=>c.estatus==='En proceso').length;
  const aten  = CIRCULARES.filter(c=>c.estatus==='Atendida').length;
  document.getElementById('st-total').textContent = total;
  document.getElementById('st-pend').textContent  = pend;
  document.getElementById('st-proc').textContent  = proc;
  document.getElementById('st-aten').textContent  = aten;
}

// â”€â”€ CYCLE STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cycleStatus(id){
  const c = CIRCULARES.find(x=>x.id===id);
  if(!c) return;
  if(c.estatus==='Atendida'){
    c.estatus='Pendiente'; c.atendidoPor=''; c.atendidoFecha=''; c.atendidoObs='';
    renderList();
    setSyncStatus('saving','Guardandoâ€¦');
    try{ await apiPost({action:'circ_setStatus',id,estatus:'Pendiente',atendidoPor:'',atendidoFecha:'',atendidoObs:''}); setSyncStatus('ok','Guardado âœ“'); showToast('Marcada como Pendiente','info'); }
    catch(e){ setSyncStatus('error',e.message); }
  } else if(c.estatus==='En proceso'){
    openAten(id);
  } else {
    c.estatus='En proceso';
    renderList();
    setSyncStatus('saving','Guardandoâ€¦');
    try{ await apiPost({action:'circ_setStatus',id,estatus:'En proceso'}); setSyncStatus('ok','Guardado âœ“'); showToast('Circular en proceso','info'); }
    catch(e){ setSyncStatus('error',e.message); }
  }
}

// â”€â”€ FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f, btn){
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderList();
}

// â”€â”€ MODAL NEW/EDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(){
  editingId = null; fileDataUrl = null; fileNameStr = null;
  document.getElementById('modalTitle').textContent = 'Nueva Circular';
  clearForm();
  document.getElementById('f-emision').value = todayStr();
  document.getElementById('modalOverlay').classList.add('open');
}
function openEdit(id){
  const c = CIRCULARES.find(x=>x.id===id);
  if(!c) return;
  editingId = id;
  fileDataUrl = c.fileData||null; fileNameStr = c.fileName||null;
  document.getElementById('modalTitle').textContent = 'Editar Circular';
  document.getElementById('f-num').value = c.num||'';
  document.getElementById('f-area').value = c.area||'';
  document.getElementById('f-titulo').value = c.titulo||'';
  document.getElementById('f-desc').value = c.desc||'';
  document.getElementById('f-emision').value = c.emision||'';
  document.getElementById('f-limite').value = c.limite||'';
  document.getElementById('f-responsable').value = c.responsable||'';
  document.getElementById('uzName').textContent = c.fileName||'';
  const lr = document.getElementById('linkRows'); lr.innerHTML='';
  (c.links||[{tipo:'ğŸ¥ Conferencia',url:''}]).forEach(l=>addLinkRow(l.tipo,l.url));
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){ document.getElementById('modalOverlay').classList.remove('open'); }
function closeOnBg(e){ if(e.target===document.getElementById('modalOverlay')) closeModal(); }
function clearForm(){
  ['f-num','f-area','f-titulo','f-desc','f-emision','f-limite','f-responsable'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('uzName').textContent='';
  document.getElementById('linkRows').innerHTML='';
  addLinkRow('ğŸ¥ Conferencia','');
}

async function guardarCircular(){
  const titulo = document.getElementById('f-titulo').value.trim();
  if(!titulo){ alert('El tÃ­tulo es obligatorio.'); return; }
  const links=[...document.querySelectorAll('#linkRows .link-row')].map(row=>({
    tipo:row.querySelector('select').value, url:row.querySelector('input').value.trim()
  })).filter(l=>l.url);
  const circular={
    id: editingId||uid(),
    num: document.getElementById('f-num').value.trim(),
    area: document.getElementById('f-area').value,
    titulo,
    desc: document.getElementById('f-desc').value.trim(),
    emision: document.getElementById('f-emision').value,
    limite: document.getElementById('f-limite').value,
    responsable: document.getElementById('f-responsable').value.trim(),
    links, fileName:fileNameStr||'', fileData:fileDataUrl||'',
    estatus: editingId?(CIRCULARES.find(x=>x.id===editingId)||{}).estatus||'Pendiente':'Pendiente',
    atendidoPor:'', atendidoFecha:'', atendidoObs:''
  };
  if(editingId){ const idx=CIRCULARES.findIndex(x=>x.id===editingId); if(idx>-1) CIRCULARES[idx]={...CIRCULARES[idx],...circular}; }
  else{ CIRCULARES.push(circular); }
  closeModal(); renderList();
  setSyncStatus('saving','Guardando en Sheetsâ€¦');
  try{ await apiPost({action:'circ_save',circular}); setSyncStatus('ok','Guardado âœ“'); showToast(editingId?'Actualizada':'Circular guardada','ok'); }
  catch(e){ setSyncStatus('error',e.message); showToast('âš  Error al guardar','info'); }
  editingId=null;
}

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteCirc(id){
  const c=CIRCULARES.find(x=>x.id===id); if(!c) return;
  document.getElementById('confirmTitle').textContent=c.titulo||'Sin tÃ­tulo';
  document.getElementById('confirmNum').textContent=c.num?`Circular ${c.num}`:'';
  document.getElementById('confirmOverlay').classList.add('open');
  document.getElementById('confirmOverlay').dataset.deleteId=id;
}
async function confirmDelete(){
  const id=document.getElementById('confirmOverlay').dataset.deleteId;
  CIRCULARES=CIRCULARES.filter(x=>x.id!==id);
  renderList(); closeConfirm();
  setSyncStatus('saving','Eliminandoâ€¦');
  try{ await apiPost({action:'circ_delete',id}); setSyncStatus('ok','Eliminado âœ“'); showToast('Circular eliminada','info'); }
  catch(e){ setSyncStatus('error',e.message); }
}
function closeConfirm(){ document.getElementById('confirmOverlay').classList.remove('open'); }

// â”€â”€ ATENDER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAten(id){
  atenId=id;
  const c=CIRCULARES.find(x=>x.id===id);
  document.getElementById('atenLabel').textContent=`"${c.titulo}" â€” Â¿quiÃ©n la atendiÃ³?`;
  document.getElementById('a-quien').value='';
  document.getElementById('a-fecha').value=todayStr();
  document.getElementById('a-obs').value='';
  document.getElementById('atenOverlay').classList.add('open');
}
function closeAten(){ document.getElementById('atenOverlay').classList.remove('open'); }
function closeAtenOnBg(e){ if(e.target===document.getElementById('atenOverlay')) closeAten(); }
async function confirmarAten(){
  const quien=document.getElementById('a-quien').value.trim();
  if(!quien){ alert('Escribe quiÃ©n atendiÃ³ la circular.'); return; }
  const c=CIRCULARES.find(x=>x.id===atenId);
  c.estatus='Atendida'; c.atendidoPor=quien;
  c.atendidoFecha=document.getElementById('a-fecha').value;
  c.atendidoObs=document.getElementById('a-obs').value.trim();
  closeAten(); renderList();
  setSyncStatus('saving','Guardandoâ€¦');
  try{ await apiPost({action:'circ_setStatus',id:atenId,estatus:'Atendida',atendidoPor:c.atendidoPor,atendidoFecha:c.atendidoFecha,atendidoObs:c.atendidoObs}); setSyncStatus('ok','Guardado âœ“'); showToast('Circular atendida âœ“','ok'); }
  catch(e){ setSyncStatus('error',e.message); }
}

function addLink(){ addLinkRow('ğŸ¥ Conferencia',''); }
function addLinkRow(tipo, url){
  const row = document.createElement('div');
  row.className = 'link-row';
  row.innerHTML = `
    <select>
      <option ${tipo==='ğŸ¥ Conferencia'?'selected':''}>ğŸ¥ Conferencia</option>
      <option ${tipo==='ğŸ“ Drive'?'selected':''}>ğŸ“ Drive</option>
      <option ${tipo==='ğŸ”— Otro'?'selected':''}>ğŸ”— Otro</option>
    </select>
    <input type="url" placeholder="https://..." value="${url}">
    <button class="btn-rm" onclick="rmLink(this)">âœ•</button>`;
  document.getElementById('linkRows').appendChild(row);
}
function rmLink(btn){ btn.closest('.link-row').remove(); }

// â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fileSelected(e){
  const file = e.target.files[0];
  if(!file) return;
  if(file.size > 5*1024*1024){ alert('El archivo no puede superar 5 MB.'); return; }
  fileNameStr = file.name;
  document.getElementById('uzName').textContent = file.name;
  const reader = new FileReader();
  reader.onload = ev => { fileDataUrl = ev.target.result; };
  reader.readAsDataURL(file);
}
function dragOver(e){ e.preventDefault(); document.getElementById('uploadZone').classList.add('drag'); }
function dragLeave(){ document.getElementById('uploadZone').classList.remove('drag'); }
function dropFile(e){
  e.preventDefault(); dragLeave();
  const file = e.dataTransfer.files[0];
  if(!file) return;
  document.getElementById('f-file').files;
  const dt = new DataTransfer(); dt.items.add(file);
  document.getElementById('f-file').files = dt.files;
  fileSelected({target:{files:[file]}});
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr(){ return new Date().toISOString().slice(0,10); }
function fmtDate(s){
  if(!s) return '';
  const [y,m,d] = s.split('-');
  const ms=['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
  return `${parseInt(d)} ${ms[parseInt(m)-1]} ${y}`;
}
function daysLeft(s){
  const today = new Date(); today.setHours(0,0,0,0);
  const limit = new Date(s+'T00:00:00');
  return Math.round((limit-today)/(1000*60*60*24));
}
function showToast(msg, type){
  const t = document.getElementById('toast');
  t.textContent = (type==='ok'?'âœ“ ':'â„¹ï¸ ') + msg;
  t.className = 'toast show ' + (type||'ok');
  clearTimeout(t._t);
  t._t = setTimeout(()=>t.classList.remove('show'),2200);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadFromSheets();
</script>
</body>
</html>

